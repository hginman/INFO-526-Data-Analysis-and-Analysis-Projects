---
title: "Tables and Data Manipulation"
author: "Hayden Ginman"
date: "2023-08-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}

#Step 1 - Install and Add Libraries to coding environment
options(repos = c(CRAN = "https://cloud.r-project.org/"))
#install.packages("dplyr")
#install.packages("reshape2")
#install.packages("gt")
library("gt")
library("dplyr")
library("reshape2")

#Step 2 - Load Data into coding environment

tobacco <- read.csv("Tobacco_Consumption.csv")

#Step 3 - Filter data to answer Question 1. How has smoking cigarettes changed over time?

cigarette_data <- tobacco %>% filter(Measure == "Cigarettes")

#Step 4 - Use group_by function to summarize total cigarette consumption by year and remove scientific notation

cigarette_total <- cigarette_data %>%
                    group_by(Year) %>%
                    summarize(Total_Consumption_of_Cigarettes = sum(Total, na.rm = TRUE))

cigarette_total$Total_Consumption_of_Cigarettes <- format(cigarette_total$Total_Consumption_of_Cigarettes, scientific=FALSE)


#Step 5 - Use group_by function to summarize average cigarette consumption per capita

cigarette_PC <- cigarette_data %>%
                group_by(Year) %>%
                summarize(Avg_Per_Capita_Consumption_of_Cigarettes = mean(`Total.Per.Capita`, na.rm = TRUE))

#Step 6 - Answer question 2. How have domestic versus imported tobacco products changed over time? Use group_by function to isolate data for Total domestic and imports by year

domestic_import_data <- tobacco %>%
                        group_by(Year) %>%
                        summarize(Total_Domestic_Tobacco = sum(Domestic, na.rm = TRUE), Total_Imports_Tobacco = sum(Imports, na.rm = TRUE))
#Step 7 - Create table for average per capita consumption

domestic_import_pc <- tobacco %>%
                      group_by(Year) %>%
                      summarize(Per_Capita_Domestic_Tobacco = mean(Domestic.Per.Capita, na.rm = TRUE), Per_Capita_Imports_Tobacco = mean(Imports.Per.Capita, na.rm = TRUE))
          
#Step 8 - Combine the Total and Average Per Capita Tables

domestic_import_combine <- left_join(domestic_import_data, domestic_import_pc, by = "Year")

#Step 9 - Answer Question 3 How has chewing tobacco consumption per capita changed over time? Filter the data for chewing tobacco

chewing_data <- tobacco %>%
                filter(Submeasure == "Chewing Tobacco")
#Step 10 - Use group-by function to group the data by year and summarize the average chewing tobacco consumption per capita

chewing_PC <- chewing_data %>%
              group_by(Year) %>%
              summarize(Avg_Domestic_Per_Capita_Chewing_Tobacco = mean(Domestic.Per.Capita, na.rm = TRUE), Avg_Imports_Per_Capita_Chewing_Tobacco = mean(Imports.Per.Capita, na.rm = TRUE))

#Step 11 - Combine the data tables that answered questions into single table

combined_data <- cigarette_total %>%
  left_join(cigarette_PC, by = "Year") %>%
  left_join(domestic_import_combine, by = "Year") %>%
  left_join(chewing_PC, by = "Year")

#Step 12 - Export Importable Table to Excel file

write.csv(combined_data, "Importable_Table.csv", row.names = FALSE)

#Step 13 - Use GT (Grammar of Tables) library to make publication table

publication_table <- combined_data %>%
  gt() %>%
  tab_header(
    title = "Tobacco Consumption Trends in the US",
    subtitle = "Yearly data on various tobacco products") %>%
  cols_label(
    Year = "Year",
    Total_Consumption_of_Cigarettes = "Total Cigarette Consumption",
    Avg_Per_Capita_Consumption_of_Cigarettes = "Average Per Capita Cigarette Consumption",
    Total_Domestic_Tobacco = "Total Domestic Tobacco Production", 
    Total_Imports_Tobacco = "Total Tobacco Imports", 
    Per_Capita_Domestic_Tobacco = "Average Domestic Tobacco Consumption Per Capita", 
    Per_Capita_Imports_Tobacco = "Average Import Tobacco Consumption", 
    Avg_Domestic_Per_Capita_Chewing_Tobacco = "Average Domestic Chewing Tobacco Consumption Per Capita",
    Avg_Imports_Per_Capita_Chewing_Tobacco = "Average Import Chewing Tobacco Consumption Per Capita") %>%
  tab_footnote(
    footnote = "Data represents both total consumption and per capita figures.",
    locations = cells_body(columns = 2:6, rows = everything())) %>%
  tab_spanner(
    label = "Cigarette Consumption",
    columns = starts_with("Total_Consumption_of_Cigarettes")) %>%
  tab_spanner(
    label = "Domestic vs Imports",
    columns = starts_with("Total_Domestic_Tobacco")) %>%
  tab_spanner(
    label = "Chewing Tobacco Consumption",
    columns = starts_with("Avg_Domestic_Per_Capita_Chewing_Tobacco"))

#Convert publication table to wide format instead of long

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
